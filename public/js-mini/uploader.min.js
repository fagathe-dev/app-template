"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),window.sessionStorage.removeItem("previewSelector");const formatFileSize=e=>`${(e/1048576).toFixed(2)} MB`,parseSize=e=>{const t=e.slice(-1).toUpperCase(),i=parseFloat(e.slice(0,-1));switch(t){case"K":return i/1024;case"M":return i;case"G":return 1024*i;default:throw new Error("Invalid size format")}},isFileSizeValid=(e,t)=>e/1048576<=parseSize(t);class FileType{constructor(){this.ARCHIVE={extensions:["zip","rar","7z"],mimeTypes:["application/zip","application/x-rar-compressed","application/x-7z-compressed"]},this.AUDIO={extensions:["mp3","wav","ogg","weba"],mimeTypes:["audio/mpeg","audio/wav","audio/ogg","audio/webm"]},this.CODE={extensions:["html","css","js","json","ts","jsx","tsx","php","py","java","c","cpp","cs","go","rb","rs","yaml","yml"],mimeTypes:["text/html","text/css","text/javascript","text/typescript","text/jsx","application/json","text/tsx","text/php","text/x-python","text/x-java","text/x-c","text/x-c++","text/x-csharp","text/x-go","text/x-ruby","text/rust","application/yaml"]},this.DOCUMENT={extensions:["doc","docx"],mimeTypes:["application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"]},this.IMAGE={extensions:["jpg","jpeg","png","gif","webp","svg","ico"],mimeTypes:["image/jpeg","image/png","image/gif","image/webp","image/svg+xml","image/x-icon"]},this.PDF={extensions:["pdf"],mimeTypes:["application/pdf"]},this.PRESENTATION={extensions:["ppt","pptx","odp","otp"],mimeTypes:["application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation","application/vnd.oasis.opendocument.presentation","application/vnd.oasis.opendocument.presentation-template"]},this.SPREADSHEET={extensions:["xls","xlsx","ods","ots"],mimeTypes:["application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.oasis.opendocument.spreadsheet","application/vnd.oasis.opendocument.spreadsheet-template"]},this.TEXT={extensions:["txt","odt","md","markdown","mdown","markdn","csv"],mimeTypes:["text/plain","application/vnd.oasis.opendocument.text","text/markdown","text/csv"]},this.VIDEO={extensions:["mp4","webm","ogg","mov","avi"],mimeTypes:["video/mp4","video/webm","video/ogg","video/quicktime","video/x-msvideo"]}}}class AudioPreviewer{constructor(e,t,i){this.CLASS="audio-preview",this.NOT_SUPPORTTED_FORMATS=[],this.previewSelector=e,this.file=t,this.container=i,this.setUpPreviewContainer(),this.render()}init(){this.setUpPreviewContainer()}setUpPreviewContainer(){var e;const t=URL.createObjectURL(this.file);let i=null;const s=null!==(e=this.file.name.split(".").pop())&&void 0!==e?e:"";if(this.NOT_SUPPORTTED_FORMATS.includes(s))console.warn("Audio format not supported"),i=this.container.querySelector(`div${this.previewSelector}`),null===i&&(i=document.createElement("div"),i.classList.add("audio-preview")),this.previewSelector.startsWith("#")&&(i.id=this.previewSelector.replace("#","")),i.innerHTML=`\n        Votre navigateur ne permet pas de lire les audios au format ".${s}". Mais vous pouvez toujours\n        <a href="${t}">la télécharger</a> !\n      `;else{i=this.container.querySelector(`audio${this.previewSelector}`),null===i&&(i=document.createElement("audio"),this.previewSelector.startsWith("#")&&(i.id=this.previewSelector.replace("#","")),this.previewSelector.startsWith(".")&&i.classList.add(this.previewSelector.replace(".","")),this.container.insertAdjacentElement("beforeend",i));const e=document.createElement("source");e.src=t,e.type=this.file.type,i.appendChild(e),i.controls=!0,i.autoplay=!1}this.previewContainer=i,this.previewContainer.onload=()=>{URL.revokeObjectURL(t)}}render(){this.container.insertAdjacentElement("beforeend",this.previewContainer)}}class ImagePreviewer{constructor(e,t,i){this.CLASS="image-preview",this.previewSelector=e,this.file=t,this.container=i,this.setUpPreviewContainer(),this.render()}init(){this.setUpPreviewContainer()}setUpPreviewContainer(){let e=this.container.querySelector(this.previewSelector);null===e&&(e=document.createElement("img"),this.previewSelector.startsWith("#")?e.id=this.previewSelector.replace("#",""):this.previewSelector.startsWith(".")&&e.classList.add(this.previewSelector.replace(".","")),this.container.insertAdjacentElement("beforeend",e)),this.previewContainer=e}render(){const e=URL.createObjectURL(this.file);this.previewContainer.src=e,this.previewContainer.alt=`Preview ${this.file.name}`,this.previewContainer.title=`Preview ${this.file.name}`,this.previewContainer.onload=()=>URL.revokeObjectURL(e)}}class VideoPreviewer{constructor(e,t,i){this.CLASS="video-preview",this.NOT_SUPPORTTED_FORMATS=["mov"],this.previewSelector=e,this.file=t,this.container=i,this.setUpPreviewContainer(),this.render()}init(){this.setUpPreviewContainer()}setUpPreviewContainer(){var e;const t=URL.createObjectURL(this.file);let i=null;const s=null!==(e=this.file.name.split(".").pop())&&void 0!==e?e:"";if(this.NOT_SUPPORTTED_FORMATS.includes(s))i=this.container.querySelector(`div${this.previewSelector}`),null===i&&(i=document.createElement("div"),i.classList.add("video-preview")),this.previewSelector.startsWith("#")&&(i.id=this.previewSelector.replace("#","")),i.innerHTML=`\n      Votre navigateur ne permet pas de lire les vidéos au format ".${s}". Mais vous pouvez toujours\n      <a href="${t}">la télécharger</a> !\n    `;else{i=this.container.querySelector(`video${this.previewSelector}`),null===i&&(i=document.createElement("video"),this.previewSelector.startsWith("#")&&(i.id=this.previewSelector.replace("#","")),this.previewSelector.startsWith(".")&&i.classList.add(this.previewSelector.replace(".","")),this.container.insertAdjacentElement("beforeend",i));const e=document.createElement("source");e.src=t,e.type=this.file.type,i.appendChild(e),i.controls=!1,i.autoplay=!0}this.previewContainer=i,this.previewContainer.onload=()=>{URL.revokeObjectURL(t)}}render(){this.container.insertAdjacentElement("beforeend",this.previewContainer)}}class PDFPreviewer{constructor(e,t,i){this.CLASS="video-preview",this.previewSelector=e,this.file=t,this.container=i,this.setUpPreviewContainer(),this.render()}init(){this.setUpPreviewContainer()}setUpPreviewContainer(){let e=this.container.querySelector(this.previewSelector);null===e&&(e=document.createElement("iframe"),this.previewSelector.startsWith("#")?e.id=this.previewSelector.replace("#",""):this.previewSelector.startsWith(".")&&e.classList.add(this.previewSelector.replace(".","")),this.container.insertAdjacentElement("beforeend",e)),this.previewContainer=e}render(){const e=URL.createObjectURL(this.file),t=`Votre navigateur ne prends pas en charge les iframes. Cliquez <a href=${e}>ici</a> pour télécharger le fichier PDF.`;this.previewContainer.src=e,this.previewContainer.style.border="none",this.previewContainer.width="100%",this.previewContainer.height="600",this.previewContainer.innerHTML=t,this.previewContainer.onload=()=>URL.revokeObjectURL(e)}}class Uploader{constructor(e,t){this.element=e,this.options=t,this.errors={file:"",fileType:"",fileSize:"",fileCount:""},this.init()}widgetSelector(){var e,t,i;let s=null!==(i=null!==(t=null===(e=this.options)||void 0===e?void 0:e.previewSelector)&&void 0!==t?t:window.sessionStorage.getItem("previewSelector"))&&void 0!==i?i:"";if(""===s&&!0===this.options.preview){const e=Str.random(10);window.sessionStorage.setItem("previewSelector",e),s=`#${e}`}this.options.previewSelector=s}setUpOptions(){const e={multiple:!1,fileType:"*",previewSelector:void 0,preview:!1,maxFileSize:"10M",maxFiles:1};this.options=Object.assign(Object.assign({},e),this.options)}getErrorsContainer(){let e=this.getElementContainer().querySelector(".invalid-feedback");return null==e&&this.hasErrors()&&(e=document.createElement("small"),e.classList.add("invalid-feedback")),e}checkFileType(e){var t;const i=null!==(t=e.name.split(".").pop())&&void 0!==t?t:"",s=e.type;let r=[],n=[];const o=new FileType;switch(this.options.fileType){case"*":r=[...o.ARCHIVE.mimeTypes,...o.AUDIO.mimeTypes,...o.CODE.mimeTypes,...o.DOCUMENT.mimeTypes,...o.IMAGE.mimeTypes,...o.PDF.mimeTypes,...o.PRESENTATION.mimeTypes,...o.SPREADSHEET.mimeTypes,...o.TEXT.mimeTypes,...o.VIDEO.mimeTypes],n=[...o.ARCHIVE.extensions,...o.AUDIO.extensions,...o.CODE.extensions,...o.DOCUMENT.extensions,...o.IMAGE.extensions,...o.PDF.extensions,...o.PRESENTATION.extensions,...o.SPREADSHEET.extensions,...o.TEXT.extensions,...o.VIDEO.extensions];break;case"ARCHIVE":r=o.ARCHIVE.mimeTypes,n=o.ARCHIVE.extensions;break;case"AUDIO":r=o.AUDIO.mimeTypes,n=o.AUDIO.extensions;break;case"CODE":r=o.CODE.mimeTypes,n=o.CODE.extensions;break;case"DOCUMENT":r=o.DOCUMENT.mimeTypes,n=o.DOCUMENT.extensions;break;case"IMAGE":r=o.IMAGE.mimeTypes,n=o.IMAGE.extensions;break;case"PDF":r=o.PDF.mimeTypes,n=o.PDF.extensions;break;case"PRESENTATION":r=o.PRESENTATION.mimeTypes,n=o.PRESENTATION.extensions;break;case"SPREADSHEET":r=o.SPREADSHEET.mimeTypes,n=o.SPREADSHEET.extensions;break;case"TEXT":r=o.TEXT.mimeTypes,n=o.TEXT.extensions;break;case"VIDEO":r=o.VIDEO.mimeTypes,n=o.VIDEO.extensions;break;default:this.errors.fileType="Invalid file type"}!1!==r.includes(s)&&!1!==n.includes(i)?this.errors.fileType&&delete this.errors.fileType:this.errors.fileType="File type is not supported"}checkFileSize(e){var t;const i=e.size,s=null!==(t=this.options.maxFileSize)&&void 0!==t?t:"20M";!1===isFileSizeValid(i,s)?this.errors.fileSize=`File size exceeds the limit of ${s}B`:this.errors.fileSize&&delete this.errors.fileSize}hasErrors(){for(const e in this.errors)""===this.errors[e]&&delete this.errors[e];return Object.keys(this.errors).length>0}handlePreview(e){!1!==this.options.preview&&("IMAGE"===this.options.fileType&&new ImagePreviewer(this.options.previewSelector,e,this.getElementContainer()),"AUDIO"===this.options.fileType&&new AudioPreviewer(this.options.previewSelector,e,this.getElementContainer()),"VIDEO"===this.options.fileType&&window.innerWidth>768&&new VideoPreviewer(this.options.previewSelector,e,this.getElementContainer()),"PDF"===this.options.fileType&&window.innerWidth>768&&new PDFPreviewer(this.options.previewSelector,e,this.getElementContainer()),this.widgetSelector())}handleErrors(){const e=this.getErrorsContainer(),t=this.getElementContainer();if(!1===this.hasErrors())return e&&e.remove(),void $(this.element).classList.remove("is-invalid");let i="";for(const e in this.errors)""!==this.errors[e]&&(i+=`${this.errors[e]}. `);e.innerHTML=i,$(this.element).classList.add("is-invalid"),t.insertAdjacentElement("beforeend",e)}handleFileChange(e){const t=Array.from(e.target.files);if(0===t.length?this.errors.fileCount="No file selected":t.length>1?this.errors.fileCount="Multiple files selection is not supported. Please select only one file":(this.errors.hasOwnProperty("fileCount")&&delete this.errors.fileCount,t.forEach(((e,t)=>{this.checkFileType(e),this.checkFileSize(e)}))),this.handleErrors(),!1===this.hasErrors())t.forEach(((e,t)=>{this.handlePreview(e)}));else if(!0===this.options.preview){const e=this.getElementContainer().querySelector(this.options.previewSelector);e&&e.remove()}}getElementContainer(){return $(this.element).parentElement}init(){this.setUpOptions(),this.errors={file:"",fileType:"",fileSize:"",fileCount:""},$(this.element).addEventListener("change",this.handleFileChange.bind(this))}}